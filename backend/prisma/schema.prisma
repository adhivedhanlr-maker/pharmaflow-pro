generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  BILLING_OPERATOR
  WAREHOUSE_MANAGER
  SALES_REP
  ACCOUNTANT
}

enum PaymentMethod {
  HOURLY
  SALARY
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  name      String
  role      Role     @default(BILLING_OPERATOR)
  canGenerateInvoice Boolean @default(false)
  isOnDuty  Boolean  @default(false)
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?
  lastLat          Float?
  lastLng          Float?
  paymentMethod    PaymentMethod @default(HOURLY)
  monthlySalary    Float    @default(0)
  hourlyRate       Float    @default(500)
  overtimeRate     Float    @default(750) // Default 1.5x of 500
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Sales     Sale[]   @relation("SaleUser")
  RepSales  Sale[]   @relation("SaleRep")
  visits    Visit[]
  orders    Order[]
  attendance Attendance[]
  routes     Route[]
  locationLogs LocationLog[]
  businessProfile BusinessProfile?
}

model Attendance {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  date      DateTime @default(now())
  startTime DateTime @default(now())
  endTime   DateTime?
  duration  Float?   // in minutes
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Product {
  id          String   @id @default(cuid())
  name        String
  hsnCode     String?
  gstRate     Float    @default(0)
  mrp         Float
  company     String?
  reorderLevel Int     @default(10)
  barcode     String?  @unique
  barcodeType String?  // "EAN13", "UPC", "CODE128", etc.
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  batches     Batch[]
  saleItems   SaleItem[]
  purchaseItems PurchaseItem[]
  orderItems    OrderItem[]

  @@index([name])
  @@index([company])
  @@index([barcode])
}

model Batch {
  id          String   @id @default(cuid())
  batchNumber String
  batchBarcode String?  @unique
  expiryDate  DateTime
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  currentStock Int     @default(0)
  mrp         Float?
  purchasePrice Float
  salePrice   Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  saleItems   SaleItem[]
  purchaseItems PurchaseItem[]

  @@unique([productId, batchNumber])
  @@index([currentStock])
  @@index([expiryDate])
  @@index([batchBarcode])
}

model Customer {
  id           String   @id @default(cuid())
  name         String
  gstin        String?
  address      String?
  phone        String?
  latitude     Float?
  longitude    Float?
  creditLimit  Float    @default(0)
  currentBalance Float  @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  sales        Sale[]
  visits       Visit[]
  orders       Order[]
  routeStops   RouteStop[]

  @@index([name])
  @@index([phone])
}

model Supplier {
  id           String   @id @default(cuid())
  name         String
  gstin        String?
  address      String?
  phone        String?
  currentBalance Float  @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  purchases    Purchase[]

  @@index([name])
  @@index([phone])
}

model Sale {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  date          DateTime @default(now())
  customerId    String
  customer      Customer @relation(fields: [customerId], references: [id])
  userId        String?
  user          User?    @relation("SaleUser", fields: [userId], references: [id])
  repId         String?  // Field for assigned Sales Rep (Delivery)
  rep           User?    @relation("SaleRep", fields: [repId], references: [id])
  totalAmount   Float
  gstAmount     Float
  netAmount     Float
  discountAmount Float   @default(0)
  isCash        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  items         SaleItem[]
  returns       SaleReturn[]
  deliveryStatus DeliveryStatus @default(PENDING)
  deliveryOtp    String?
  deliveredAt    DateTime?
  deliveryProofUrl String?
  deliverySignatureUrl String?
  deliveryLatitude  Float?
  deliveryLongitude Float?
  deliveryInfo      String?
}

enum DeliveryStatus {
  PENDING
  DELIVERED
  RETURNED
}

model SaleItem {
  id          String   @id @default(cuid())
  saleId      String
  sale        Sale     @relation(fields: [saleId], references: [id])
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  batchId     String
  batch       Batch    @relation(fields: [batchId], references: [id])
  quantity    Int
  unitPrice   Float
  gstRate     Float
  gstAmount   Float
  totalAmount Float
  returns     SaleReturnItem[]
}

model Purchase {
  id            String   @id @default(cuid())
  billNumber    String
  date          DateTime @default(now())
  supplierId    String
  supplier      Supplier @relation(fields: [supplierId], references: [id])
  totalAmount   Float
  gstAmount     Float
  netAmount     Float
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  items         PurchaseItem[]
  returns       PurchaseReturn[]
}

model PurchaseItem {
  id          String   @id @default(cuid())
  purchaseId  String
  purchase    Purchase @relation(fields: [purchaseId], references: [id])
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  batchId     String
  batch       Batch    @relation(fields: [batchId], references: [id])
  quantity    Int
  purchasePrice Float
  gstRate     Float
  gstAmount   Float
  totalAmount Float
  returns     PurchaseReturnItem[]
}

model SaleReturn {
  id          String   @id @default(cuid())
  saleId      String
  sale        Sale     @relation(fields: [saleId], references: [id])
  date        DateTime @default(now())
  totalAmount Float
  items       SaleReturnItem[]
}

model SaleReturnItem {
  id          String     @id @default(cuid())
  saleReturnId String
  saleReturn  SaleReturn @relation(fields: [saleReturnId], references: [id])
  saleItemId  String
  saleItem    SaleItem   @relation(fields: [saleItemId], references: [id])
  quantity    Int
  reason      String?
}

model PurchaseReturn {
  id          String   @id @default(cuid())
  purchaseId  String
  purchase    Purchase @relation(fields: [purchaseId], references: [id])
  date        DateTime @default(now())
  totalAmount Float
  items       PurchaseReturnItem[]
}

model PurchaseReturnItem {
  id                String         @id @default(cuid())
  purchaseReturnId  String
  purchaseReturn    PurchaseReturn @relation(fields: [purchaseReturnId], references: [id])
  purchaseItemId    String
  purchaseItem      PurchaseItem   @relation(fields: [purchaseItemId], references: [id])
  quantity          Int
  reason            String?
}

model Notification {
  id        String   @id @default(cuid())
  type      String   // LOW_STOCK, EXPIRY, SYSTEM
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}




model BusinessProfile {
  id          String   @id @default(cuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @unique
  companyName String
  gstin       String?
  email       String?
  phone       String?
  address     String?
  logoUrl     String?  // Path to uploaded logo file
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String   // e.g., "LOGIN", "CREATE_SALE", "DELETE_USER"
  entity    String?  // e.g., "Sale", "User", "Product"
  entityId  String?  // ID of the affected entity
  details   Json?    // Additional metadata
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model Visit {
  id          String   @id @default(cuid())
  repId       String
  rep         User     @relation(fields: [repId], references: [id])
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id])
  checkInTime DateTime @default(now())
  latitude    Float
  longitude   Float
  distance    Float?   // Distance from shop in meters
  status      String   // "VERIFIED" or "MISMATCH"
  createdAt   DateTime @default(now())

  @@index([repId])
  @@index([customerId])
  @@index([createdAt])
}
model Order {
  id            String      @id @default(cuid())
  orderNumber   String      @unique
  customerId    String
  customer      Customer    @relation(fields: [customerId], references: [id])
  repId         String
  rep           User        @relation(fields: [repId], references: [id])
  status        OrderStatus @default(PENDING)
  totalAmount   Float
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  items         OrderItem[]

  @@index([customerId])
  @@index([repId])
  @@index([status])
}

model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  quantity    Int
  price       Float
  isBackorder Boolean  @default(false)
}

enum OrderStatus {
  PENDING
  PROCESSING
  READY
  CANCELLED
}

model Route {
  id        String      @id @default(cuid())
  repId     String
  rep       User        @relation(fields: [repId], references: [id])
  date      DateTime
  status    RouteStatus @default(DRAFT)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  stops     RouteStop[]

  @@unique([repId, date])
  @@index([repId])
  @@index([date])
}

model RouteStop {
  id         String     @id @default(cuid())
  routeId    String
  route      Route      @relation(fields: [routeId], references: [id])
  customerId String
  customer   Customer   @relation(fields: [customerId], references: [id])
  stopOrder  Int
  status     StopStatus @default(PENDING)
  notes      String?
  visitedAt  DateTime?

  @@index([routeId])
  @@index([customerId])
}

enum RouteStatus {
  DRAFT
  ACTIVE
  COMPLETED
}

enum StopStatus {
  PENDING
  COMPLETED
  SKIPPED
}

model LocationLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  latitude  Float
  longitude Float
  timestamp DateTime @default(now())

  @@index([userId])
  @@index([timestamp])
}
